{{>navigation}}
<!-- index.hbs -->
<div class="container">
  <h1 class="text-center">Bienvenido a VibeBones</h1>

  {{#if user}}
    <p class="text-center">Hola, {{user.dataValues.commerceName}}</p>
  {{/if}}

  <div id="products-container" class="mt-4">
    {{#if products.length}}
      <div class="row row-cols-1 row-cols-md-3 g-4">
        {{#each products}}
          <div class="col">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">{{this.title}}</h5>
                <p class="card-text">{{this.description}}</p>
                <p class="card-text">Precio: {{this.price}}</p>
                <p class="card-text">Stock: {{this.stock}}</p>
                <div class="btn-group mt-2" role="group">
                  <a href="/api/v1/view/products/update/{{this.id}}" class="btn btn-primary btn-sm update-product">Actualizar</a>
                  <button type="button" class="btn btn-danger btn-sm delete-product" data-product-id="{{this.id}}">Eliminar</button>
                </div>
              </div>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <p class="text-center">No hay productos disponibles.</p>
    {{/if}}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const response = await fetch('/api/v1/view/products', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const data = await response.json();

      console.log("desde el index");
      console.log(data);
      console.log("termina el index");

      const productsContainer = document.getElementById('products-container');
      productsContainer.innerHTML = '';

      if (response.status === 200) {
        if (data.products.length > 0) {
          const productsHtml = data.products.map(product => `
            <div class="col">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">${product.title}</h5>
                  <p class="card-text">${product.description}</p>
                  <p class="card-text">Precio: ${product.price}</p>
                  <p class="card-text">Stock: ${product.stock}</p>
                  <div class="btn-group mt-2" role="group">
                    <a href="/api/v1/view/products/update/${product.id}" class="btn btn-primary btn-sm update-product">Actualizar</a>
                    <button type="button" class="btn btn-danger btn-sm delete-product" data-product-id="${product.id}">Eliminar</button>
                  </div>
                </div>
              </div>
            </div>
          `).join('');

          productsContainer.innerHTML = `
            <div class="row row-cols-1 row-cols-md-3 g-4">
              ${productsHtml}
            </div>
          `;

          // Agregar event listener para el botón de actualizar
          document.querySelectorAll('.update-product').forEach(button => {
            button.addEventListener('click', async (event) => {
              event.preventDefault();
              const productId = button.getAttribute('href').split('/').pop();
              window.location.assign(`/api/v1/view/products/update/${productId}`);
            });
          });

          // Agregar event listener para el botón de eliminar
          document.querySelectorAll('.delete-product').forEach(button => {
            button.addEventListener('click', async () => {
              const productId = button.getAttribute('data-product-id');
              try {
                const response = await fetch(`/api/v1/view/products/${productId}`, {
                  method: 'DELETE',
                  headers: {
                    'Content-Type': 'application/json',
                  }
                });

                const data = await response.json();

                if (response.status === 200) {
                  console.log('Producto eliminado:', data.message);
                  window.location.reload(); // Recargar la página para reflejar los cambios
                } else {
                  console.error('Error al eliminar producto:', data.message);
                }
              } catch (error) {
                console.error('Error al eliminar producto:', error.message);
              }
            });
          });
        } else {
          productsContainer.innerHTML = '<p class="text-center">No hay productos disponibles.</p>';
        }
      } else {
        console.error('Error al cargar productos:', data.message);
      }
    } catch (error) {
      console.error('Error al cargar productos:', error.message);
    }
  });
</script>
